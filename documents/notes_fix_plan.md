# План по исправлению функционала заметок

## 1. Введение

Этот документ описывает план по диагностике и исправлению проблемы с пропавшими заметками в приложении EvaCalendar. Заметки являются важной частью пользовательского интерфейса, позволяя пользователям сохранять текстовую информацию, привязанную к конкретной неделе.

**Описание проблемы:** Пользователи сообщают, что блок заметок перестал отображаться в интерфейсе.

**Ожидаемое поведение:**
*   Блок заметок должен отображаться в первой половине недели, после среды.
*   Блок должен содержать текстовое поле для ввода заметки и кнопку "Сохранить".
*   Заметки должны сохраняться в базе данных, привязанные к дате начала недели.
*   Существующие заметки должны корректно загружаться и отображаться для соответствующей недели.

## 2. Диагностика проблемы (Режим Архитектора и Отладки)

Цель этого этапа - точно определить причину исчезновения заметок.

### 2.1. Анализ Бэкенда

*   **Проверка API эндпоинтов для заметок:**
    *   Убедиться, что существуют эндпоинты для получения (`GET`), создания/обновления (`POST`/`PUT`) заметок.
    *   Проверить контроллеры (`back/controllers/noteController.js`) и сервисы (`back/services/noteService.js`), отвечающие за логику работы с заметками.
    *   Проанализировать запросы к БД: корректно ли формируются SQL-запросы для извлечения и сохранения заметок? Используется ли правильное поле `date` (дата начала недели)?
*   **Проверка модели данных и миграций БД:**
    *   Убедиться, что таблица `notes` в БД (`back/data/database.sqlite`) соответствует схеме (поля: `id`, `date`, `content`).
    *   Проверить миграции (`back/migrations/create_notes_table.js`) на корректность создания таблицы.
    *   Проверить сиды (`back/seeds/notes_seed.js`), если они используются для начального заполнения.
*   **Логирование:**
    *   Проанализировать логи сервера на наличие ошибок, связанных с обработкой запросов к заметкам.
    *   При необходимости добавить дополнительное логирование в `noteController.js` и `noteService.js` для отслеживания потока данных и возможных ошибок.

### 2.2. Анализ Фронтенда

*   **Проверка компонента заметок:**
    *   Определить компонент, отвечающий за отображение заметок (вероятно, `front/src/components/NoteField.tsx` или внутри `front/src/components/FirstHalfOfWeek.tsx`).
    *   Проверить логику отображения: при каких условиях компонент рендерится? Корректно ли он получает данные о заметках?
*   **Проверка запросов к API:**
    *   Используя инструменты разработчика в браузере, отследить запросы на получение данных о заметках.
    *   Проверить, отправляются ли запросы, какой ответ приходит от сервера, есть ли ошибки сети или HTTP-ошибки.
*   **Управление состоянием:**
    *   Проанализировать, как состояние заметок (текст, статус загрузки) управляется на фронтенде (например, с использованием React Context `front/src/context/NavContext.tsx` или локального состояния компонента).
*   **Логика отображения:**
    *   Убедиться, что логика, определяющая местоположение блока заметок (после среды, в первой половине недели), реализована корректно в компоненте `front/src/components/FirstHalfOfWeek.tsx` или аналогичном.

### 2.3. Интеграционное тестирование

*   Проверить взаимодействие между фронтендом и бэкендом в части функционала заметок.
*   Убедиться, что данные, отправленные с фронтенда, корректно сохраняются в БД и затем правильно извлекаются и отображаются.

## 3. Разработка и реализация исправления (Режим Кода)

На основе результатов диагностики будут определены конкретные шаги по исправлению.

### 3.1. Бэкенд

*   **Исправление ошибок в API:** Если найдены ошибки в логике контроллеров, сервисов или запросов к БД, внести необходимые исправления.
    *   Файлы: `back/controllers/noteController.js`, `back/services/noteService.js`.
*   **Корректировка схемы/миграций БД:** Если проблема в структуре БД, создать новые миграции для исправления. (Маловероятно, если схема предоставлена и верна).

### 3.2. Фронтенд

### 3.2.1. Фронтенд - Часть 1: Детализация Задачи (31.05.2025)

**Контекст из диагностики и предыдущих шагов:**
*   Компонент [`front/src/components/NoteField.tsx`](front/src/components/NoteField.tsx:0) закомментирован в [`front/src/components/FirstHalfOfWeek.tsx`](front/src/components/FirstHalfOfWeek.tsx:50).
*   [`NoteField.tsx`](front/src/components/NoteField.tsx:0) пытался получить заметку по `GET /notes/${weekId}`. Новый эндпоинт: `GET /api/notes/date/:dateString`.
*   Логика сохранения в [`NoteField.tsx`](front/src/components/NoteField.tsx:0) не различала создание (POST) и обновление (PUT) заметки.
*   В [`front/src/services/api.ts`](front/src/services/api.ts:0) отсутствуют функции для работы с API заметок.

**Задачи:**

1.  **Раскомментировать компонент:**
    *   В файле [`front/src/components/FirstHalfOfWeek.tsx`](front/src/components/FirstHalfOfWeek.tsx:50) раскомментировать `<NoteField ... />`. Передать `weekId` (дата начала недели 'YYYY-MM-DD').

2.  **Обновить сервисный слой ([`front/src/services/api.ts`](front/src/services/api.ts:0)):**
    *   Добавить асинхронные функции:
        *   `getNoteByDate(dateString)`: `GET /api/notes/date/${dateString}`.
        *   `createNote(dateString, content)`: `POST /api/notes` с телом `{ date: dateString, content: content }`.
        *   `updateNote(uuid, content)`: `PUT /api/notes/${uuid}` с телом `{ content: content }`.
    *   Обработка ответов и ошибок.

3.  **Обновить компонент [`front/src/components/NoteField.tsx`](front/src/components/NoteField.tsx:0):**
    *   **Получение заметки:**
        *   Использовать `getNoteByDate(weekId)` из [`api.ts`](front/src/services/api.ts:0) при монтировании и изменении `weekId`.
        *   Сохранять `noteUuid` (или `null`/`undefined`).
    *   **Сохранение заметки (функция `handleSaveNote`):**
        *   Если `noteUuid` есть: `updateNote(noteUuid, noteContent)` из [`api.ts`](front/src/services/api.ts:0).
        *   Если `noteUuid` нет: `createNote(weekId, noteContent)` из [`api.ts`](front/src/services/api.ts:0). Обновить `noteUuid` после создания.
    *   Обновить обработку ошибок и состояний загрузки.

4.  **Тестирование:**
    *   Написать или обнови юнит-тесты для [`front/src/components/NoteField.tsx`](front/src/components/NoteField.tsx:0).
    *   Проверить сценарии:
        *   Отображение компонента.
        *   Загрузка существующей заметки.
        *   Отображение пустого поля, если заметки нет.
        *   Создание новой заметки.
        *   Обновление существующей заметки.
    *   Убедиться, что моки для функций из [`api.ts`](front/src/services/api.ts:0) используются корректно.
*   **Исправление компонента заметок:**
    *   Если проблема в логике отображения или получения данных, исправить соответствующий компонент (`front/src/components/NoteField.tsx`, `front/src/components/FirstHalfOfWeek.tsx`).
    *   Убедиться, что компонент правильно обрабатывает случаи отсутствия заметки для недели и позволяет создать новую.
*   **Корректировка запросов к API:**
    *   Исправить формирование запросов или обработку ответов в `front/src/services/api.ts` или непосредственно в компонентах.
*   **Обновление управления состоянием:**
    *   Внести изменения в логику управления состоянием, если это необходимо.

### 3.3. Написание/обновление тестов

*   **Бэкенд:**
    *   Написать или обновить юнит-тесты для `noteController.js` и `noteService.js`.
    *   Проверить сценарии создания, получения, обновления заметок.
    *   Файл тестов: `back/tests/notes.test.js`.
*   **Фронтенд:**
    *   Написать или обновить тесты для компонента заметок, проверяя его отображение, взаимодействие с пользователем и отправку данных.
    *   Возможно, потребуется создать новый файл тестов для `NoteField.tsx`, если его нет.

## 4. Тестирование и отладка (Режим Отладки)

*   **Ручное тестирование:**
    *   Проверить функционал заметок в различных сценариях:
        *   Создание новой заметки.
        *   Редактирование существующей заметки.
        *   Удаление заметки (если такой функционал предполагается).
        *   Отображение заметок при переключении между неделями.
        *   Корректное отображение блока заметок (после среды).
*   **Автоматизированное тестирование:**
    *   Запустить все написанные тесты (бэкенд и фронтенд) и убедиться в их прохождении.
*   **Отладка:**
    *   При возникновении проблем использовать инструменты отладки (логи, дебаггеры браузера и Node.js) для их устранения.

## 5. Документирование (Режим Архитектора)

*   Обновить любую существующую документацию (например, README, комментарии в коде), если в ходе исправления были внесены значительные изменения в архитектуру или логику работы функционала.
*   Убедиться, что данный план (`notes_fix_plan.md`) актуален и отражает выполненные работы.

## 6. Заключение

После выполнения всех шагов данного плана функционал заметок должен быть полностью восстановлен и работать корректно.