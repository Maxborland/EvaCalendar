# Изменения в бэкенде (31.05.2025)

В этот день в бэкенд проекта были внесены существенные изменения, направленные на улучшение структуры базы данных, обработки ошибок и актуализацию тестового покрытия.

## Ключевые изменения:

1.  **Переход на UUID**: Большинство сущностей (`Children`, `Tasks`, `Notes`, `ExpenseCategories`) теперь используют UUID в качестве первичных ключей вместо автоинкрементных ID. Это изменение затрагивает миграции, сиды, сервисы и тесты.
2.  **Улучшенная обработка ошибок**:
    *   Внедрен кастомный класс `ApiError` для стандартизации HTTP-ответов об ошибках (например, 400 Bad Request, 404 Not Found).
    *   Контроллеры теперь используют параметр `next` для передачи ошибок в централизованный middleware-обработчик.
    *   Сервисы выполняют более строгую валидацию входных данных, включая проверку обязательных полей и существование связанных сущностей.
3.  **Обновление схемы данных**:
    *   В таблице `tasks` поле `dueDate` стало обязательным.
    *   Поле `description` в задачах было заменено на `comments` или удалено из обязательных.
4.  **Актуализация тестов**: Все затронутые тесты были обновлены для соответствия изменениям в API, включая использование UUID, проверку новых кодов ответа и форматов сообщений об ошибках.
5.  **Рефакторинг**: В `taskController.js` добавлен `asyncHandler` для упрощения обработки асинхронных операций и ошибок.

## Детализация по компонентам:

### 1. Контроллеры

*   **[`back/controllers/expenseCategoryController.js`](back/controllers/expenseCategoryController.js:1)**:
    *   Интегрирован `ApiError` для обработки ошибок.
    *   Используется `next` для передачи ошибок в middleware.
*   **[`back/controllers/noteController.js`](back/controllers/noteController.js:1)**:
    *   Интегрирован `ApiError`.
    *   Используется `next` для передачи ошибок.
*   **[`back/controllers/taskController.js`](back/controllers/taskController.js:1)**:
    *   Интегрирован `ApiError`.
    *   Добавлен `asyncHandler` для обработки асинхронных маршрутов.
    *   Улучшена логика обработки ошибок "Not Found" при получении, обновлении и удалении задач.

### 2. Миграции базы данных

*   **[`back/migrations/create_children_table.js`](back/migrations/create_children_table.js:1)**:
    *   Первичный ключ `uuid` изменен на тип `uuid`.
*   **[`back/migrations/create_tasks_table.js`](back/migrations/create_tasks_table.js:1)**:
    *   Первичный ключ `uuid` изменен на тип `uuid`.
    *   Поле `dueDate` сделано обязательным (`notNullable`).
    *   Внешние ключи `childId` и `expenceTypeId` обновлены для ссылки на `uuid` в соответствующих таблицах.

### 3. Сиды (начальные данные)

*   **[`back/seeds/children_seed.js`](back/seeds/children_seed.js:1)**:
    *   Для каждой записи генерируется `uuid`.
*   **[`back/seeds/notes_seed.js`](back/seeds/notes_seed.js:1)**:
    *   Для каждой записи генерируется `uuid`.
*   **[`back/seeds/tasks_seed.js`](back/seeds/tasks_seed.js:1)**:
    *   Для каждой записи генерируется `uuid`.
    *   Внешние ключи `childId` и `expenceTypeId` используют `uuid` связанных записей.
    *   Поле `dueDate` устанавливается для каждой задачи.

### 4. Сервисы

*   **[`back/services/childrenService.js`](back/services/childrenService.js:1)**:
    *   Используется `uuid` для идентификации записей.
    *   Генерируется `uuid` при создании нового ребенка.
    *   Добавлена проверка обязательных полей с использованием `ApiError.badRequest`.
*   **[`back/services/expenseCategoryService.js`](back/services/expenseCategoryService.js:1)**:
    *   Используется `uuid` для идентификации записей.
    *   Генерируется `uuid` при создании новой категории.
    *   Добавлена проверка обязательных полей (`category_name`) с использованием `ApiError.badRequest`.
    *   Все методы обернуты в `try...catch` для логирования и проброса ошибок.
*   **[`back/services/noteService.js`](back/services/noteService.js:1)**:
    *   Используется `uuid` для идентификации записей.
    *   Генерируется `uuid` при создании новой заметки.
    *   Добавлена проверка обязательных полей (`date`, `content`) с использованием `ApiError.badRequest`.
    *   Все методы обернуты в `try...catch`.
*   **[`back/services/summaryService.js`](back/services/summaryService.js:1)**:
    *   Значительных изменений, связанных с переходом на `uuid` или `ApiError`, не обнаружено. Логика расчетов осталась прежней.
*   **[`back/services/taskService.js`](back/services/taskService.js:1)**:
    *   Используется `uuid` для идентификации и связей.
    *   Генерируется `uuid` при создании новой задачи.
    *   Добавлена функция `validateExistence` для проверки существования связанных `childId` и `expenceTypeId`.
    *   Обновлен список обязательных полей при создании (`title`, `dueDate`, `type`).
    *   Обновлены запросы `leftJoin` для получения имен связанных сущностей (`childName`, `expenseCategoryName`).
    *   Улучшена валидация при обновлении задач.

### 5. Тесты

*   **[`back/tests/children.test.js`](back/tests/children.test.js:1)**:
    *   Тесты адаптированы под использование `uuid`.
    *   Добавлены проверки на коды ответа 400 (отсутствие обязательных полей) и 404 (ресурс не найден).
    *   Обновлены ожидания для кодов ответа (201, 200, 204).
*   **[`back/tests/expenseCategory.test.js`](back/tests/expenseCategory.test.js:1)**:
    *   Аналогичные изменения: использование `uuid`, проверка на 400 и 404, обновление ожидаемых кодов ответа.
*   **[`back/tests/notes.test.js`](back/tests/notes.test.js:1)**:
    *   Аналогичные изменения: использование `uuid`, проверка на 400 (отсутствие `date`) и 404, обновление ожидаемых кодов ответа.
*   **[`back/tests/tasks.test.js`](back/tests/tasks.test.js:1)**:
    *   Тесты адаптированы под использование `uuid` для задач, `childId` и `categoryUuid`.
    *   Обновлены данные для создания/обновления задач (удалено `description`, используется `comments`, `type` обязателен).
    *   Добавлены проверки на коды ответа 400 (отсутствие обязательных полей, например, `type`) и 404.
    *   Обновлены ожидания для кодов ответа, включая проверку, что при обновлении возвращается количество измененных строк.